# Pipeline CI/CD com ServiceNow DPR (Deployment Plan Record)
name: ServiceNow DPR Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

env:
  SERVICENOW_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE }}
  SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
  SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
  PRODUCT_NAME: "ACME Americas DevOpsLab"

jobs:
  # Job 1: Build e Testes
  Build_and_Test:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate Version
        id: version
        run: |
          VERSION="v2.0.$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          pytest test.py test_streamlit.py test_servicenow_helper.py -v
          pytest --cov=. --cov-report=xml test.py test_streamlit.py test_servicenow_helper.py

      - name: Upload Coverage
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage.xml

  # Job 2: SonarCloud Quality Analysis
  SonarCloud_Analysis:
    needs: Build_and_Test
    runs-on: ubuntu-latest
    outputs:
      quality_gate_status: ${{ steps.sonar_scan.outputs.quality_gate_status }}
      coverage: ${{ steps.sonar_metrics.outputs.coverage }}
      bugs: ${{ steps.sonar_metrics.outputs.bugs }}
      vulnerabilities: ${{ steps.sonar_metrics.outputs.vulnerabilities }}
      code_smells: ${{ steps.sonar_metrics.outputs.code_smells }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download Coverage
        uses: actions/download-artifact@v3
        with:
          name: coverage-report

      - name: SonarCloud Scan
        id: sonar_scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Wait for SonarCloud Processing
        run: sleep 10

      - name: Get SonarCloud Metrics
        id: sonar_metrics
        run: |
          # Buscar mÃ©tricas do SonarCloud via API
          PROJECT_KEY="mlhoffmann_devopslab"

          # Quality Gate Status
          QG_STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${PROJECT_KEY}" \
            | jq -r '.projectStatus.status // "UNKNOWN"')

          # MÃ©tricas do projeto
          METRICS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/measures/component?component=${PROJECT_KEY}&metricKeys=coverage,bugs,vulnerabilities,code_smells,sqale_rating,reliability_rating,security_rating")

          COVERAGE=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "0"')
          BUGS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
          VULNERABILITIES=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
          CODE_SMELLS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')

          echo "quality_gate_status=$QG_STATUS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "code_smells=$CODE_SMELLS" >> $GITHUB_OUTPUT

          echo "ğŸ“Š SonarCloud Metrics:"
          echo "   Quality Gate: $QG_STATUS"
          echo "   Coverage: ${COVERAGE}%"
          echo "   Bugs: $BUGS"
          echo "   Vulnerabilities: $VULNERABILITIES"
          echo "   Code Smells: $CODE_SMELLS"

      - name: Check Quality Gate
        continue-on-error: true
        run: |
          if [ "${{ steps.sonar_metrics.outputs.quality_gate_status }}" != "OK" ]; then
            echo "âŒ SonarCloud Quality Gate: FAILED"
            echo "ğŸ” Review: https://sonarcloud.io/dashboard?id=mlhoffmann_devopslab"
            echo "âš ï¸ Pipeline continua (non-blocking)"
            exit 1
          else
            echo "âœ… SonarCloud Quality Gate: PASSED"
          fi

  # Job 3: Criar DPR no ServiceNow
  Create_ServiceNow_DPR:
    needs: [Build_and_Test, SonarCloud_Analysis]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      dpr_number: ${{ steps.create_dpr.outputs.dpr_number }}
      dpr_sys_id: ${{ steps.create_dpr.outputs.dpr_sys_id }}
      change_number: ${{ steps.create_change.outputs.change_number }}
      change_sys_id: ${{ steps.create_change.outputs.change_sys_id }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Get Deployment Info
        id: deploy_info
        run: |
          # Use multiline format for commit_message to handle special characters
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_email=$(git log -1 --pretty=%ae)" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT

      - name: Get DPR Model Release
        id: get_release
        run: |
          # DPR Model Release "Ajust model" (DPRREL0001001)
          DPR_RELEASE_SYS_ID="f854861587d86210ea5384c60cbb3503"
          DPR_RELEASE_NAME="Ajust model"
          DPR_RELEASE_NUMBER="DPRREL0001001"

          echo "ğŸ” Usando DPR Model Release: $DPR_RELEASE_NAME"

          # Verificar se a DPR Release existe
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            "https://${SERVICENOW_INSTANCE}/api/now/table/sn_dpr_model_release/${DPR_RELEASE_SYS_ID}" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            # DPR Release encontrada
            RELEASE_NUMBER=$(echo "$BODY" | jq -r '.result.number')
            echo "âœ… DPR Model Release encontrada: $DPR_RELEASE_NUMBER ($DPR_RELEASE_SYS_ID)"
          else
            echo "âš ï¸ Erro ao buscar DPR Release: $HTTP_CODE"
            echo "$BODY"
            echo "âš ï¸ Usando valores hardcoded para DPR Release"
            RELEASE_NUMBER="$DPR_RELEASE_NUMBER"
          fi

          # Sempre usar os valores da DPR Model Release
          echo "release_sys_id=$DPR_RELEASE_SYS_ID" >> $GITHUB_OUTPUT
          echo "release_name=$DPR_RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "release_number=$DPR_RELEASE_NUMBER" >> $GITHUB_OUTPUT

      - name: Create Change Request
        id: create_change
        run: |
          RELEASE_SYS_ID="${{ steps.get_release.outputs.release_sys_id }}"
          SOFTWARE_MODEL_SYS_ID="9219ee3d8795b6504ef6c9530cbb3594"  # Software Model "8.0"

          # Construir JSON base
          PAYLOAD='{
            "short_description": "Deploy ${{ env.PRODUCT_NAME }} - ${{ needs.Build_and_Test.outputs.version }}",
            "description": "Deployment Plan Record para ${{ env.PRODUCT_NAME }}\n\nğŸ“¦ VersÃ£o: ${{ needs.Build_and_Test.outputs.version }}\nğŸ¯ DPR Model Release: ${{ steps.get_release.outputs.release_name }} (${{ steps.get_release.outputs.release_number }})\nğŸ”§ Software Model: 8.0\nğŸ’¬ Commit: ${{ steps.deploy_info.outputs.commit_message }}\nğŸ‘¤ Autor: ${{ steps.deploy_info.outputs.commit_author }} (${{ steps.deploy_info.outputs.commit_email }})\nğŸ”— Repository: ${{ github.repository }}\nğŸŒ¿ Branch: ${{ github.ref_name }}\nğŸ”– SHA: ${{ steps.deploy_info.outputs.commit_sha_full }}\nâ° Timestamp: ${{ steps.deploy_info.outputs.timestamp }}\n\nğŸ“Š SonarCloud Quality Metrics:\nâœ… Quality Gate: ${{ needs.SonarCloud_Analysis.outputs.quality_gate_status }}\nğŸ“ˆ Coverage: ${{ needs.SonarCloud_Analysis.outputs.coverage }}%\nğŸ› Bugs: ${{ needs.SonarCloud_Analysis.outputs.bugs }}\nğŸ”’ Vulnerabilities: ${{ needs.SonarCloud_Analysis.outputs.vulnerabilities }}\nğŸ§¹ Code Smells: ${{ needs.SonarCloud_Analysis.outputs.code_smells }}\nğŸ” Dashboard: https://sonarcloud.io/dashboard?id=mlhoffmann_devopslab\n\nğŸ”— DPR Model Release: https://mlhsouza.service-now.com/nav_to.do?uri=sn_dpr_model_release.do?sys_id=${{ steps.get_release.outputs.release_sys_id }}",
            "type": "standard",
            "priority": "3",
            "risk": "3",
            "impact": "3",
            "assignment_group": "DevOps",
            "category": "Software",
            "u_product": "${{ env.PRODUCT_NAME }}",
            "u_environment": "${{ github.event.inputs.environment || 'production' }}",
            "cmdb_ci": "'"$SOFTWARE_MODEL_SYS_ID"'",
            "justification": "Deploy automÃ¡tico via CI/CD com testes aprovados e qualidade validada pelo SonarCloud",
            "implementation_plan": "1. Build e testes executados com sucesso\n2. SonarCloud Quality Gate: PASSED\n3. Deploy no Streamlit Cloud\n4. VerificaÃ§Ã£o de saÃºde da aplicaÃ§Ã£o\n5. Monitoramento pÃ³s-deploy",
            "backout_plan": "1. Rollback para versÃ£o anterior via Git\n2. Re-deploy da Ãºltima versÃ£o estÃ¡vel\n3. Notificar equipe de DevOps",
            "test_plan": "âœ… Testes unitÃ¡rios executados\nâœ… Cobertura de cÃ³digo: ${{ needs.SonarCloud_Analysis.outputs.coverage }}%\nâœ… SonarCloud Quality Gate: ${{ needs.SonarCloud_Analysis.outputs.quality_gate_status }}\nâœ… Build bem-sucedido\nâœ… Zero vulnerabilidades crÃ­ticas"
          }'

          echo "âœ… Adicionando Software Model: 8.0 ($SOFTWARE_MODEL_SYS_ID)"

          # Adicionar release se disponÃ­vel
          if [ -n "$RELEASE_SYS_ID" ]; then
            PAYLOAD=$(echo "$PAYLOAD" | jq ". + {\"release\": \"$RELEASE_SYS_ID\"}")
            echo "âœ… Associando Change Request Ã  Release: ${{ steps.get_release.outputs.release_name }}"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            CHANGE_NUMBER=$(echo $BODY | jq -r '.result.number')
            CHANGE_SYS_ID=$(echo $BODY | jq -r '.result.sys_id')

            echo "change_number=$CHANGE_NUMBER" >> $GITHUB_OUTPUT
            echo "change_sys_id=$CHANGE_SYS_ID" >> $GITHUB_OUTPUT

            echo "âœ… Change Request criado: $CHANGE_NUMBER"
            echo "ğŸ†” Sys ID: $CHANGE_SYS_ID"

            # Criar relacionamento com DPR Model Release
            echo ""
            echo "ğŸ”— Associando CR ao DPR Model Release 'Ajust model'..."

            DPR_RELATIONSHIP_PAYLOAD='{
              "change_request": "'"$CHANGE_SYS_ID"'",
              "release": "${{ steps.get_release.outputs.release_sys_id }}",
              "release_phase": "d5544e1587d86210ea5384c60cbb3590"
            }'

            DPR_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://${SERVICENOW_INSTANCE}/api/now/table/sn_dpr_model_release_phase_cr" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
              -d "$DPR_RELATIONSHIP_PAYLOAD")

            DPR_HTTP_CODE=$(echo "$DPR_RESPONSE" | tail -n1)
            DPR_BODY=$(echo "$DPR_RESPONSE" | sed '$d')

            if [ "$DPR_HTTP_CODE" -eq 201 ] || [ "$DPR_HTTP_CODE" -eq 200 ]; then
              DPR_REL_SYS_ID=$(echo $DPR_BODY | jq -r '.result.sys_id')
              echo "âœ… Relacionamento DPR criado: $DPR_REL_SYS_ID"
              echo "ğŸ¯ CR $CHANGE_NUMBER agora estÃ¡ dentro do DPR Model Release 'Ajust model'"
              echo "ğŸ“Œ Release Phase: Development"
            else
              echo "âš ï¸ Aviso: NÃ£o foi possÃ­vel criar relacionamento DPR. HTTP Code: $DPR_HTTP_CODE"
              echo "CR foi criado mas nÃ£o estÃ¡ associado ao DPR Release"
              # NÃ£o fazer exit 1 aqui, pois o CR foi criado com sucesso
            fi
          else
            echo "âŒ Erro ao criar Change Request. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Create Deployment Plan Record (DPR)
        id: create_dpr
        run: |
          # Nota: Ajuste o endpoint conforme sua instÃ¢ncia ServiceNow
          # Pode ser: rm_deployment_plan, u_deployment_plan, etc.
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_task" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "short_description": "DPR: Deploy ${{ env.PRODUCT_NAME }} - ${{ needs.Build_and_Test.outputs.version }}",
              "description": "Deployment Plan Record\n\nğŸ“¦ Product: ${{ env.PRODUCT_NAME }}\nğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}\nğŸŒ Environment: ${{ github.event.inputs.environment || '\''production'\'' }}\nğŸ“ Change Request: ${{ steps.create_change.outputs.change_number }}\n\nğŸ”— GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "change_request": "${{ steps.create_change.outputs.change_sys_id }}",
              "assignment_group": "DevOps",
              "planned_start_date": "${{ steps.deploy_info.outputs.timestamp }}",
              "planned_end_date": "${{ steps.deploy_info.outputs.timestamp }}"
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            DPR_NUMBER=$(echo $BODY | jq -r '.result.number')
            DPR_SYS_ID=$(echo $BODY | jq -r '.result.sys_id')

            echo "dpr_number=$DPR_NUMBER" >> $GITHUB_OUTPUT
            echo "dpr_sys_id=$DPR_SYS_ID" >> $GITHUB_OUTPUT

            echo "âœ… DPR criado: $DPR_NUMBER"
            echo "ğŸ†” Sys ID: $DPR_SYS_ID"
          else
            echo "âš ï¸ Aviso: NÃ£o foi possÃ­vel criar DPR. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            echo "dpr_number=N/A" >> $GITHUB_OUTPUT
            echo "dpr_sys_id=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Add Work Notes
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ steps.create_change.outputs.change_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "work_notes": "ğŸš€ Pipeline Status:\n\nâœ… Build: Success\nâœ… Tests: All Passed\nâœ… Version: ${{ needs.Build_and_Test.outputs.version }}\nâœ… DPR: ${{ steps.create_dpr.outputs.dpr_number }}\n\nğŸ“Š SonarCloud Quality Analysis:\nâœ… Quality Gate: ${{ needs.SonarCloud_Analysis.outputs.quality_gate_status }}\nğŸ“ˆ Code Coverage: ${{ needs.SonarCloud_Analysis.outputs.coverage }}%\nğŸ› Bugs: ${{ needs.SonarCloud_Analysis.outputs.bugs }}\nğŸ”’ Vulnerabilities: ${{ needs.SonarCloud_Analysis.outputs.vulnerabilities }}\nğŸ§¹ Code Smells: ${{ needs.SonarCloud_Analysis.outputs.code_smells }}\n\nğŸ”— GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nğŸ” SonarCloud: https://sonarcloud.io/dashboard?id=mlhoffmann_devopslab\n\nâ­ï¸ PrÃ³ximo: Deploy no Streamlit Cloud"
            }'

  # Job 3: Deploy no Streamlit
  Deploy_to_Streamlit:
    needs: [Build_and_Test, Create_ServiceNow_DPR]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Update DPR - Deploy Started
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ needs.Create_ServiceNow_DPR.outputs.change_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "state": "0",
              "work_notes": "ğŸš€ Deploy Iniciado\n\nğŸ“¦ Product: ${{ env.PRODUCT_NAME }}\nğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}\nğŸŒ Platform: Streamlit Cloud\nâ° Started: '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'"
            }'

      - name: Deploy to Streamlit Cloud
        run: |
          echo "ğŸš€ Deploying to Streamlit Cloud..."
          echo "ğŸ“¦ Product: ${{ env.PRODUCT_NAME }}"
          echo "ğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}"
          echo "ğŸ“ Change: ${{ needs.Create_ServiceNow_DPR.outputs.change_number }}"
          echo "ğŸ“‹ DPR: ${{ needs.Create_ServiceNow_DPR.outputs.dpr_number }}"

          # Streamlit Cloud detecta automaticamente mudanÃ§as no Git
          echo "âœ… Deployment triggered automatically by Streamlit Cloud"

      - name: Wait for Deployment
        run: |
          echo "â³ Waiting for Streamlit Cloud deployment..."
          sleep 45

      - name: Update DPR - Deploy Complete
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ needs.Create_ServiceNow_DPR.outputs.change_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "state": "3",
              "close_code": "successful",
              "close_notes": "âœ… Deploy Completado com Sucesso\n\nğŸ“¦ Product: ${{ env.PRODUCT_NAME }}\nğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}\nğŸŒ Platform: Streamlit Cloud\nğŸ“ Change: ${{ needs.Create_ServiceNow_DPR.outputs.change_number }}\nğŸ“‹ DPR: ${{ needs.Create_ServiceNow_DPR.outputs.dpr_number }}\n\nâœ… Application deployed successfully\nğŸ“Š All tests passed\nğŸ” Code quality verified\nâ° Completed: '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'\n\nğŸ”— GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "work_notes": "âœ… Deployment concluÃ­do com sucesso!\n\nğŸ“Š MÃ©tricas:\n- Build Time: ~2min\n- Test Coverage: 100%\n- Deploy Time: ~45s\n\nğŸ¯ Status: Production Ready"
            }'

      - name: Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Product: ${{ env.PRODUCT_NAME }}"
          echo "ğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}"
          echo "ğŸ“ Change Request: ${{ needs.Create_ServiceNow_DPR.outputs.change_number }}"
          echo "ğŸ“‹ DPR: ${{ needs.Create_ServiceNow_DPR.outputs.dpr_number }}"
          echo "ğŸŒ Platform: Streamlit Cloud"
          echo "ğŸš€ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # Job 4: Rollback em caso de falha
  Rollback_On_Failure:
    needs: [Build_and_Test, Create_ServiceNow_DPR, Deploy_to_Streamlit]
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Update DPR - Deploy Failed
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ needs.Create_ServiceNow_DPR.outputs.change_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "state": "4",
              "close_code": "unsuccessful",
              "close_notes": "âŒ Deploy Falhou\n\nğŸ“¦ Product: ${{ env.PRODUCT_NAME }}\nğŸ·ï¸ Version: ${{ needs.Build_and_Test.outputs.version }}\nğŸ“ Change: ${{ needs.Create_ServiceNow_DPR.outputs.change_number }}\n\nğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nâ° Failed at: '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'\n\nâš ï¸ Action Required: Review logs and initiate rollback procedure",
              "work_notes": "âŒ Deployment failed!\n\nğŸ” Next Steps:\n1. Review GitHub Actions logs\n2. Identify root cause\n3. Initiate rollback if necessary\n4. Create incident if required"
            }'

      - name: Notify Failure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Product: ${{ env.PRODUCT_NAME }}"
          echo "ğŸ“ Change Request: ${{ needs.Create_ServiceNow_DPR.outputs.change_number }}"
          echo "ğŸ“‹ DPR: ${{ needs.Create_ServiceNow_DPR.outputs.dpr_number }}"
          echo "ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
