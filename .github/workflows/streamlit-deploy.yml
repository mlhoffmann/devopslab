# Pipeline CI/CD com ServiceNow - Modo Automatico ou Com Aprovacao
# Use workflow_dispatch para escolher o modo de deploy
name: Streamlit Deploy Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Modo de Deploy'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - com_aprovacao

env:
  SERVICENOW_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE }}
  SERVICENOW_USERNAME: ${{ secrets.SERVICENOW_USERNAME }}
  SERVICENOW_PASSWORD: ${{ secrets.SERVICENOW_PASSWORD }}
  DPR_RELEASE_SYS_ID: ${{ secrets.DPR_RELEASE_SYS_ID }}
  DPR_PHASE_SYS_ID: ${{ secrets.DPR_PHASE_SYS_ID }}
  # Define modo: se foi push usa 'com_aprovacao', se foi manual usa o input
  DEPLOY_MODE: ${{ github.event_name == 'push' && 'com_aprovacao' || inputs.deploy_mode }}

jobs:
  # Job 1: Build e Testes
  Build:
    runs-on: ubuntu-latest

    steps:
      - name: Show Deploy Mode
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "MODO DE DEPLOY: ${{ env.DEPLOY_MODE }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ env.DEPLOY_MODE }}" == "auto" ]; then
            echo "Deploy AUTOMATICO - sem gate de aprovacao"
          else
            echo "Deploy COM APROVACAO - aguarda ServiceNow"
          fi

      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Requirements
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Unit Tests
        run: |
          pytest test_streamlit.py -v

      - name: Generate Coverage Report
        run: |
          coverage run --source=. -m pytest test_streamlit.py
          coverage report -m
          coverage xml -i

      - name: SonarCloud Scan
        continue-on-error: true
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Job 2: Criar Change Request no ServiceNow
  ServiceNow_Change_Request:
    needs: Build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      change_request_number: ${{ steps.create_cr.outputs.cr_number }}
      change_request_sys_id: ${{ steps.create_cr.outputs.cr_sys_id }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Get Commit Info
        id: commit_info
        run: |
          echo "commit_message=$(git log -1 --pretty=%s | head -c 100)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create ServiceNow Change Request
        id: create_cr
        run: |
          RESPONSE=$(curl -s -X POST \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "short_description": "Deploy Streamlit App - Commit ${{ steps.commit_info.outputs.commit_sha }}",
              "description": "Deploy via GitHub Actions\n\nCommit: ${{ steps.commit_info.outputs.commit_message }}\nAutor: ${{ steps.commit_info.outputs.commit_author }}\nRepositorio: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nModo: ${{ env.DEPLOY_MODE }}",
              "type": "standard",
              "priority": "3",
              "risk": "3",
              "impact": "3"
            }')

          CR_NUMBER=$(echo $RESPONSE | jq -r '.result.number')
          CR_SYS_ID=$(echo $RESPONSE | jq -r '.result.sys_id')

          echo "cr_number=$CR_NUMBER" >> $GITHUB_OUTPUT
          echo "cr_sys_id=$CR_SYS_ID" >> $GITHUB_OUTPUT
          echo "âœ… Change Request criado: $CR_NUMBER"

          # Associar ao DPR Model Release (valores vem dos secrets)
          curl -s -X POST \
            "https://${SERVICENOW_INSTANCE}/api/now/table/sn_dpr_model_release_phase_cr" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d "{\"change_request\": \"$CR_SYS_ID\", \"release\": \"${DPR_RELEASE_SYS_ID}\", \"release_phase\": \"${DPR_PHASE_SYS_ID}\"}"

          echo "âœ… CR associado ao DPR Model Release 'Ajust model'"

      - name: Set CR State Based on Mode
        run: |
          if [ "${{ env.DEPLOY_MODE }}" == "com_aprovacao" ]; then
            # Modo com aprovacao: mover para Authorize (-3)
            STATE="-3"
            WORK_NOTES="Pipeline Status:\n- âœ… Build: Success\n- âœ… Tests: Passed\n\nâ³ CR em estado AUTHORIZE\nğŸ“‹ Aprove esta CR para liberar o deploy!\nğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "Movendo CR para Authorize (aguardando aprovacao)"
          else
            # Modo automatico: manter em estado padrao
            STATE="0"
            WORK_NOTES="Pipeline Status:\n- âœ… Build: Success\n- âœ… Tests: Passed\n\nğŸš€ Deploy AUTOMATICO em andamento\nğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "Modo automatico - deploy sem aprovacao"
          fi

          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ steps.create_cr.outputs.cr_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d "{\"state\": \"$STATE\", \"work_notes\": \"$WORK_NOTES\"}"

  # Job 3: Gate de Aprovacao (so executa se modo = com_aprovacao)
  Wait_For_Approval:
    needs: ServiceNow_Change_Request
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.deploy_mode == 'com_aprovacao'))
    timeout-minutes: 30

    steps:
      - name: Wait for ServiceNow Approval
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ AGUARDANDO APROVACAO NO SERVICENOW"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Change Request: ${{ needs.ServiceNow_Change_Request.outputs.change_request_number }}"
          echo ""
          echo "ğŸ” A CR esta no estado AUTHORIZE (-3)"
          echo "ğŸ“‹ Aprove a CR no ServiceNow para liberar o deploy"
          echo ""

          CR_SYS_ID="${{ needs.ServiceNow_Change_Request.outputs.change_request_sys_id }}"
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s -X GET \
              "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${CR_SYS_ID}?sysparm_fields=state,number" \
              -H "Accept: application/json" \
              -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}")

            STATE=$(echo $RESPONSE | jq -r '.result.state')
            CR_NUMBER=$(echo $RESPONSE | jq -r '.result.number')

            STATE_NAME="Desconhecido"
            case $STATE in
              "-5") STATE_NAME="New" ;;
              "-4") STATE_NAME="Assess" ;;
              "-3") STATE_NAME="Authorize (aguardando)" ;;
              "-1") STATE_NAME="Scheduled (aprovada)" ;;
              "-2") STATE_NAME="Implement" ;;
              "0")  STATE_NAME="Review" ;;
              "3")  STATE_NAME="Closed" ;;
              "4")  STATE_NAME="Canceled" ;;
            esac

            echo "[$ATTEMPT/$MAX_ATTEMPTS] CR: $CR_NUMBER | Estado: $STATE ($STATE_NAME)"

            if [ "$STATE" == "-1" ] || [ "$STATE" == "-2" ]; then
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… CHANGE REQUEST APROVADA!"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ğŸš€ Prosseguindo com o deploy..."
              exit 0
            fi

            if [ "$STATE" == "4" ] || [ "$STATE" == "3" ]; then
              echo ""
              echo "âŒ CHANGE REQUEST CANCELADA/FECHADA!"
              exit 1
            fi

            sleep 30
          done

          echo "â° TIMEOUT! CR nao foi aprovada em 30 minutos."
          exit 1

  # Job 4: Deploy Automatico (so executa se modo = auto)
  Deploy_Auto:
    needs: ServiceNow_Change_Request
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch' && inputs.deploy_mode == 'auto'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Deploy to Streamlit Cloud
        run: |
          echo "ğŸš€ Deploy AUTOMATICO iniciado!"
          echo "Change Request: ${{ needs.ServiceNow_Change_Request.outputs.change_request_number }}"
          echo "âœ… Deploy sem gate de aprovacao"

      - name: Update CR - Deploy Complete
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ needs.ServiceNow_Change_Request.outputs.change_request_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "state": "-4",
              "work_notes": "âœ… Deploy AUTOMATICO concluido!\nâ° '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'"
            }'

      - name: Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY AUTOMATICO CONCLUIDO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ CR: ${{ needs.ServiceNow_Change_Request.outputs.change_request_number }}"
          echo "ğŸš€ Modo: AUTOMATICO (sem aprovacao)"

  # Job 5: Deploy Com Aprovacao (so executa apos Wait_For_Approval)
  Deploy_Com_Aprovacao:
    needs: [ServiceNow_Change_Request, Wait_For_Approval]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Deploy to Production Branch
        run: |
          echo "ğŸš€ Deploy COM APROVACAO iniciado!"
          echo "Change Request: ${{ needs.ServiceNow_Change_Request.outputs.change_request_number }}"
          echo "âœ… CR foi aprovada no ServiceNow"
          echo ""
          echo "Fazendo push para branch production..."
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch origin production
          git checkout production
          git merge main --no-edit
          git push origin production
          echo "âœ… CÃ³digo deployado na branch production"
          echo "â³ Streamlit Cloud detectarÃ¡ e farÃ¡ deploy automaticamente"

      - name: Update CR - Deploy Complete
        run: |
          curl -X PATCH \
            "https://${SERVICENOW_INSTANCE}/api/now/table/change_request/${{ needs.ServiceNow_Change_Request.outputs.change_request_sys_id }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -u "${SERVICENOW_USERNAME}:${SERVICENOW_PASSWORD}" \
            -d '{
              "state": "-4",
              "work_notes": "âœ… Deploy COM APROVACAO concluido!\nâ° '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'"
            }'

      - name: Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY COM APROVACAO CONCLUIDO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ CR: ${{ needs.ServiceNow_Change_Request.outputs.change_request_number }}"
          echo "ğŸš€ Modo: COM APROVACAO"
